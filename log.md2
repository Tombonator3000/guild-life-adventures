# log.md2 — Development Log (Session 2)

## 2026-02-25 — Fix curse appliance notification: show both Forge and Enchanter repair options

### Problem
When Grimwald cursed and broke an appliance, the `CurseAppliancePanel` showed:
- "Repair cost: 70g at the Enchanter" (hardcoded single location)
- Cost was wrong: `originalPrice * 0.5` (50% of purchase price), but actual Enchanter repair is only 5–25% of original
- Forge (the cheaper option) was never mentioned

### Root Cause
`hexHelpers.ts` stored `repairCost = Math.floor(originalPrice * 0.5)` in the curse event — far too high and misleading. Normal breakage correctly uses `calculateRepairCost()` (5-25% random). The `CurseAppliancePanel` also hardcoded "at the Enchanter" in the UI.

### Changes Made

**`src/store/storeTypes.ts`**
- Added `originalPrice?: number` field to `applianceBreakageEvent` type

**`src/store/helpers/hexHelpers.ts`**
- Added `import { calculateRepairCost } from '@/data/items'`
- Changed curse `repairCost` from `Math.floor(originalPrice * 0.5)` → `calculateRepairCost(originalPrice)` (correct 5–25% range)
- Added `originalPrice` field to the curse `applianceBreakageEvent` so the panel can compute both repair cost ranges

**`src/components/game/CurseAppliancePanel.tsx`**
- Replaced `repairCost` prop with `originalPrice` prop
- Computes cost ranges: Enchanter 5–25%, Forge 50% of that (min 5g)
- Now shows both repair options side-by-side:
  - Forge: ~{forgeMin}–{forgeMax}g • 3h (in green, highlighted as cheaper)
  - Enchanter: ~{enchanterMin}–{enchanterMax}g • 2h

**`src/components/game/GameBoard.tsx`**
- Updated `CurseAppliancePanel` invocation to pass `originalPrice` instead of `repairCost`
- Fallback: `originalPrice ?? repairCost * 2` for old saves missing the field
- Normal breakage toast updated: "at the Enchanter or Market" → "(Forge is cheaper)"

---

## 2026-02-24 — Remove "Rest X & End" button; auto-use remaining time on End Turn

### Context
User requested removal of the "Rest {X}h & End" button that appeared below the End Turn button in ResourcePanel. Instead, remaining hours should be automatically used when End Turn is clicked, based on the player's current location.

### Changes Made

**`src/components/game/ResourcePanel.tsx`**
- Removed `spendRemainingTime` from `useGameStore()` destructure
- Removed the "Rest {X}h & End" button block entirely

**`src/store/helpers/turnHelpers.ts`**
- Added `import { getJob } from '@/data/jobs'`
- Added `JOB_LOCATION_NAMES` map (locationId → job location name string)
- Added `applyRemainingTimeAtLocation(set, get, playerId)` helper function:
  - At job location (player has job + is at matching location): auto-work remaining hours via `workShift`. Falls through to generic rest if clothing check fails.
  - At own home (slums renter at slums / noble renter at noble-heights): proportional happiness + health + relaxation bonuses scaled by hours/8 (sleep) and hours/relaxRate (relax)
  - Anywhere else: generic rest — 1 happiness per 4 hours (min 1)
- In `endTurn`: call `applyRemainingTimeAtLocation` BEFORE spoilage check; re-read `endingPlayer` from fresh state after mutation

**`CLAUDE.md`**
- Added convention note: no "Rest X & End" button; remaining time is auto-consumed in `endTurn` via `applyRemainingTimeAtLocation`

### Test Results
- 358 tests passed (18 test files) ✓

---

## 2026-02-25 — Random Event Rate & Weekend Event Display

### Task 1: Reduce Random Event Chance to 5%, Max 1 Per Week

**Problem**: Random events were too frequent (location events: 20% gate, travel events: 15%, theft: 30% gate, sickness: 5%). Players could get multiple events per week.

**Changes**:

**`src/data/events.ts`**
- Location event gate: 20% → 5% (one per week enforced by `hadRandomEventThisTurn`)
- `checkWeeklyTheft` gate: 30% → 5%

**`src/data/travelEvents.ts`**
- `TRAVEL_EVENT_CHANCE`: 0.15 → 0.05

**`src/store/helpers/weekEndHelpers.ts`**
- Added `WEEK_END_RANDOM_EVENT_CHANCE = 0.05` constant
- In `processPlayerWeekEnd`: save `hadRandomEventThisTurn` BEFORE `resetWeeklyFlags` (saves pre-reset value as `hadEventThisWeek`)
- Week-end random events (theft/sickness) now gated by both `!hadEventThisWeek` AND 5% roll
- This ensures max 1 random event per week total — prevents double events from in-turn + week-end
- `limitWeekendMessages` cap: 2 → 5 (all shown on 1 screen now, can show more)

### Task 2: Weekend Events on 1 Screen (No Multiple Continues)

**Problem**: Weekend event messages were paginated (1 "continue" click per line) because `GameBoard.tsx` split `description` by `\n` and queued each line separately.

**Changes**:

**`src/components/game/GameBoard.tsx`**
- Added `eventSource` to store subscription
- Added `isWeekendEvent = eventSource === 'weekend'` check
- Weekend events: `eventLines = []`, `totalEventCount = 1`, `currentEventLine = full description`
- Weekend events always dismiss with 1 click (no queue pagination)
- `EventPanel` already supports multi-line via `description.split('\n')` — no EventPanel changes needed

**`CLAUDE.md`**
- Updated `hadRandomEventThisTurn` note to mention the week-end flag-save pattern
- Added note about all random event chance rates (5% each)
- Updated `limitWeekendMessages` note (max 5, single screen)

### Test Impact
- No logic regressions expected — changes are additive (additional gates reduce event frequency)
