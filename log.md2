# log.md2 — Development Log (Session 2)

## 2026-02-26 09:30 — Refactor: Code clarity improvements in actionGenerator.ts and weekEndHelpers.ts

### Problem
Two files had inline code blocks that were inconsistent with the surrounding pattern of named helper functions, making them harder to read and test in isolation.

### Changes

**1. `src/hooks/ai/actionGenerator.ts`**
- Extracted 3 inline blocks from `generateActions()` into named functions:
  - `applyCounterStrategy(actions, rivals, planningDepth)` — wraps the guard + counter-weight lookup that was inline in the function body
  - `applyMultiNeedLocationBonus(actions)` — route optimization: boosts moves to locations that satisfy multiple needs (was an inline for-loop pair)
  - `applyTurnPlanRouteBoost(actions, player, settings, ...)` — hard AI turn-plan route boost (was an inline if-block calling `identifyNeededVisits`/`planTurnRoute`)
- `generateActions()` body now consists entirely of named function calls, consistent with the existing `applyPersonalityWeights`, `applyVelocityAdjustments`, etc.
- **No behavior change** — identical logic, just reorganized

**2. `src/store/helpers/weekEndHelpers.ts`**
- In `limitWeekendMessages()`, extracted a long chain of `!m.includes(...)` into:
  - `MUNDANE_WEEKEND_TAGS` constant array listing all weekend activity tag prefixes
  - `isMundaneWeekendMessage(msg)` arrow function using `.some()` against the array
  - `isCriticalMessage(msg)` arrow function (moved from inline lambda to named helper)
- Makes adding/removing mundane tags in future a single-line change to the constant
- **No behavior change** — identical filter logic

### Tests
- 358/358 passing ✓
- Build clean ✓

---

## 2026-02-26 07:54 — AI intelligence optimization: 7 improvements to AI decision-making

### Changes made

**1. Fix: Graduate travel bug** (`goalActions.ts`)
- `generateGraduationActions`: previously only graduated when ALREADY at academy. Now generates a high-priority (80) `move` action to travel to academy when a degree has all sessions complete but isn't graduated yet.
- `generateEducationActions`: same fix — when `sessionsLeft <= 0` and not at academy, generates travel action (priority 82) instead of silently doing nothing. Added early `return` to avoid studying already-completed degrees.
- Impact: AI was completing all sessions for a degree but never going to collect the graduation. Free education points + happiness bonuses were being left on the table indefinitely.

**2. Raise proactive education degree cap** (`strategicActions.ts`)
- `generateProactiveEducationActions`: raised cap from 4 degrees to 8 for hard AI, 5 for medium AI.
- Previously AI stopped pursuing education at 4 degrees even when more would unlock better jobs or provide education goal progress.

**3. Lower job upgrade threshold for hard AI** (`strategicActions.ts`)
- `generateJobUpgradeActions`: hard AI now upgrades when new job pays >10% more (was 20% for all difficulties).
- Medium/easy AI still use 20% threshold (less aggressive job shopping).

**4. Expand education pipeline to medium AI** (`strategicActions.ts`)
- `generateEducationPipelineActions`: lowered depth requirement from `>= 3` (hard only) to `>= 2` (medium + hard).
- Hard AI uses 1.2x wage threshold (was 1.3x); medium AI uses 1.3x.
- Medium AI can now pursue targeted education to unlock better-paying jobs.

**5. Add salary negotiation travel action** (`strategicActions.ts`)
- `generateSalaryNegotiationActions`: hard AI now travels to job location to request a raise if 6+ shifts worked and enough time for travel + another shift. Priority 42 (low — doesn't override important tasks).

**6. Opportunistic ticket buying** (`economicActions.ts`)
- Removed `weakestGoal === 'happiness'` gate for ticket purchases. AI now buys tickets when at Shadow Market with gold > 150g regardless of current focus goal.
- Priority 48 when happiness is weakest, 30 otherwise (cheap opportunistic happiness).

**7. Festival action priority boosts** (`goalActions.ts`)
- All festival bonus actions had their priorities raised by ~6-10 points since festivals are time-limited.
- Education festival: study 75→82, travel 70→76. Wage festival: work 72→78, added travel action (72). Dungeon festival: explore 74→80, travel 69→74. Food festival: buy 52→58.
- Also: wage festival now generates a travel action to the job location (previously only boosted work when already there).

### Tests: 358 passed (all passing)

## 2026-02-25 — Fix curse appliance notification: show both Forge and Enchanter repair options

### Problem
When Grimwald cursed and broke an appliance, the `CurseAppliancePanel` showed:
- "Repair cost: 70g at the Enchanter" (hardcoded single location)
- Cost was wrong: `originalPrice * 0.5` (50% of purchase price), but actual Enchanter repair is only 5–25% of original
- Forge (the cheaper option) was never mentioned

### Root Cause
`hexHelpers.ts` stored `repairCost = Math.floor(originalPrice * 0.5)` in the curse event — far too high and misleading. Normal breakage correctly uses `calculateRepairCost()` (5-25% random). The `CurseAppliancePanel` also hardcoded "at the Enchanter" in the UI.

### Changes Made

**`src/store/storeTypes.ts`**
- Added `originalPrice?: number` field to `applianceBreakageEvent` type

**`src/store/helpers/hexHelpers.ts`**
- Added `import { calculateRepairCost } from '@/data/items'`
- Changed curse `repairCost` from `Math.floor(originalPrice * 0.5)` → `calculateRepairCost(originalPrice)` (correct 5–25% range)
- Added `originalPrice` field to the curse `applianceBreakageEvent` so the panel can compute both repair cost ranges

**`src/components/game/CurseAppliancePanel.tsx`**
- Replaced `repairCost` prop with `originalPrice` prop
- Computes cost ranges: Enchanter 5–25%, Forge 50% of that (min 5g)
- Now shows both repair options side-by-side:
  - Forge: ~{forgeMin}–{forgeMax}g • 3h (in green, highlighted as cheaper)
  - Enchanter: ~{enchanterMin}–{enchanterMax}g • 2h

**`src/components/game/GameBoard.tsx`**
- Updated `CurseAppliancePanel` invocation to pass `originalPrice` instead of `repairCost`
- Fallback: `originalPrice ?? repairCost * 2` for old saves missing the field
- Normal breakage toast updated: "at the Enchanter or Market" → "(Forge is cheaper)"

---

## 2026-02-24 — Remove "Rest X & End" button; auto-use remaining time on End Turn

### Context
User requested removal of the "Rest {X}h & End" button that appeared below the End Turn button in ResourcePanel. Instead, remaining hours should be automatically used when End Turn is clicked, based on the player's current location.

### Changes Made

**`src/components/game/ResourcePanel.tsx`**
- Removed `spendRemainingTime` from `useGameStore()` destructure
- Removed the "Rest {X}h & End" button block entirely

**`src/store/helpers/turnHelpers.ts`**
- Added `import { getJob } from '@/data/jobs'`
- Added `JOB_LOCATION_NAMES` map (locationId → job location name string)
- Added `applyRemainingTimeAtLocation(set, get, playerId)` helper function:
  - At job location (player has job + is at matching location): auto-work remaining hours via `workShift`. Falls through to generic rest if clothing check fails.
  - At own home (slums renter at slums / noble renter at noble-heights): proportional happiness + health + relaxation bonuses scaled by hours/8 (sleep) and hours/relaxRate (relax)
  - Anywhere else: generic rest — 1 happiness per 4 hours (min 1)
- In `endTurn`: call `applyRemainingTimeAtLocation` BEFORE spoilage check; re-read `endingPlayer` from fresh state after mutation

**`CLAUDE.md`**
- Added convention note: no "Rest X & End" button; remaining time is auto-consumed in `endTurn` via `applyRemainingTimeAtLocation`

### Test Results
- 358 tests passed (18 test files) ✓

---

## 2026-02-25 — Random Event Rate & Weekend Event Display

### Task 1: Reduce Random Event Chance to 5%, Max 1 Per Week

**Problem**: Random events were too frequent (location events: 20% gate, travel events: 15%, theft: 30% gate, sickness: 5%). Players could get multiple events per week.

**Changes**:

**`src/data/events.ts`**
- Location event gate: 20% → 5% (one per week enforced by `hadRandomEventThisTurn`)
- `checkWeeklyTheft` gate: 30% → 5%

**`src/data/travelEvents.ts`**
- `TRAVEL_EVENT_CHANCE`: 0.15 → 0.05

**`src/store/helpers/weekEndHelpers.ts`**
- Added `WEEK_END_RANDOM_EVENT_CHANCE = 0.05` constant
- In `processPlayerWeekEnd`: save `hadRandomEventThisTurn` BEFORE `resetWeeklyFlags` (saves pre-reset value as `hadEventThisWeek`)
- Week-end random events (theft/sickness) now gated by both `!hadEventThisWeek` AND 5% roll
- This ensures max 1 random event per week total — prevents double events from in-turn + week-end
- `limitWeekendMessages` cap: 2 → 5 (all shown on 1 screen now, can show more)

### Task 2: Weekend Events on 1 Screen (No Multiple Continues)

**Problem**: Weekend event messages were paginated (1 "continue" click per line) because `GameBoard.tsx` split `description` by `\n` and queued each line separately.

**Changes**:

**`src/components/game/GameBoard.tsx`**
- Added `eventSource` to store subscription
- Added `isWeekendEvent = eventSource === 'weekend'` check
- Weekend events: `eventLines = []`, `totalEventCount = 1`, `currentEventLine = full description`
- Weekend events always dismiss with 1 click (no queue pagination)
- `EventPanel` already supports multi-line via `description.split('\n')` — no EventPanel changes needed

**`CLAUDE.md`**
- Updated `hadRandomEventThisTurn` note to mention the week-end flag-save pattern
- Added note about all random event chance rates (5% each)
- Updated `limitWeekendMessages` note (max 5, single screen)

### Test Impact
- No logic regressions expected — changes are additive (additional gates reduce event frequency)

## 2026-02-28 14:15 — Refactor: weekEndHelpers.ts — processNeeds and processDeathChecks

### Problem
Two functions in `weekEndHelpers.ts` mixed multiple concerns, had poor variable names, and were hard to read and test in isolation:

1. **`processNeeds`** (64 lines) combined food depletion and clothing degradation in a single body. The clothing section used underscore-prefixed variables (`_clothingJob`, `_jobThreshold`) as a signal that the naming was awkward. The `FOOD_PER_UNIT` constant was a needless alias for `FOOD_DEPLETION_PER_WEEK`.

2. **`processDeathChecks`** embedded a 4-line resurrection cost formula inline, and the main loop had 3 levels of nested `if/else` that were hard to follow at a glance.

### Changes

**`src/store/helpers/weekEndHelpers.ts`**

**processNeeds → processFoodDepletion + processClothingDegradation:**
- Extracted `processFoodDepletion(p, decayMultiplier)` — food drain + Preservation Box auto-replenishment, no messages (food starvation handled at turn start)
- Extracted `processClothingDegradation(p, decayMultiplier, msgs)` — clothing wear, tier-change messages, job-requirement warnings; AI players exit early with `if (p.isAI) return`
- Renamed `_clothingJob`/`_jobThreshold` → `clothingJob`/`jobThreshold` (no underscore needed)
- Removed redundant `p.clothingCondition > 0` guard in else-if (already excluded by prior `<= 0` branch)
- `processNeeds` becomes a 5-line coordinator: compute decay multiplier, call two helpers

**processDeathChecks → calculateResurrectionCost + handleSecondDeath + attemptResurrection:**
- Extracted `calculateResurrectionCost(gold, savings): number` — pure function, easy to unit test; uses named `wealthAboveThreshold` variable instead of a one-liner Math.min/max chain
- Extracted `handleSecondDeath(p, enablePermadeath, msgs)` — handles already-resurrected case (double-resurrection exploit guard)
- Extracted `attemptResurrection(p, enablePermadeath, msgs)` — handles first-death: deduct from savings, minimal respawn, or permadeath
- `processDeathChecks` loop body is now 2 lines (`handleSecondDeath` or `attemptResurrection`)

### Test Impact
- All 358 tests pass — identical behavior, no logic changes
- `calculateResurrectionCost` is now a pure named function that can be unit-tested directly
