<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <!-- Prevent browser HTTP caching of this HTML page.
         GitHub Pages sets Cache-Control: max-age=600 (10 min). During that window,
         a stale cached HTML file may reference old JS chunk hashes that no longer exist
         on the server, causing "Loading the realm..." to hang forever.
         These meta tags tell the browser to always revalidate this page. -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <link rel="icon" type="image/png" href="/favicon.png" />
    <title>Guild Life</title>
    <meta name="description" content="A fantasy life simulation game inspired by Jones in the Fast Lane">
    <meta name="author" content="Guild Life Adventures" />

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#2e1f0f" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Guild Life" />
    <link rel="apple-touch-icon" href="apple-touch-icon.png" />

    <!-- Google Fonts - loaded as <link> instead of CSS @import to avoid render-blocking -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet" />

    <!-- Open Graph -->


    <meta property="og:type" content="website" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta property="og:title" content="Guild Life">
  <meta name="twitter:title" content="Guild Life">
  <meta property="og:description" content="A fantasy life simulation game inspired by Jones in the Fast Lane">
  <meta name="twitter:description" content="A fantasy life simulation game inspired by Jones in the Fast Lane">
</head>

  <body>
    <div id="root">
      <!-- Loading screen — visible until React mounts and replaces this content -->
      <div id="loading-screen" style="min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#1f170a;color:#e8dcc8;font-family:serif;text-align:center;padding:2rem;">
        <h1 style="font-size:2rem;margin-bottom:1rem;color:#d4a537;">Guild Life Adventures</h1>
        <p style="font-size:1rem;opacity:0.7;">Loading the realm...</p>
        <noscript><p style="margin-top:1rem;color:#c44;">JavaScript is required to play this game.</p></noscript>
      </div>
    </div>
    <!-- Catch JS errors that occur before React mounts (module load failures, etc.) -->
    <script>
      window.__guildLoadErrors=[];
      function __guildShowLoadError(msg){
        setTimeout(function(){
          var ls=document.getElementById('loading-screen');
          if(!ls)return;
          if(ls.querySelector('.error-info'))return;
          var d=document.createElement('div');
          d.className='error-info';
          d.style.cssText='margin-top:1rem;';
          d.innerHTML='<p style="color:#c44;font-size:0.95rem;">Failed to load the realm</p>'
            +'<p style="font-size:0.8rem;opacity:0.7;max-width:500px;word-break:break-word;">'+msg+'</p>'
            +'<button onclick="location.reload()" style="margin-top:1rem;padding:.5rem 1.5rem;background:#d4a537;color:#1f170a;border:none;border-radius:4px;cursor:pointer;font-size:1rem;">Reload</button>';
          ls.appendChild(d);
        },3000);
      }
      window.onerror=function(msg,src,line,col,err){
        window.__guildLoadErrors.push({msg:msg,src:src,err:err});
        __guildShowLoadError(msg);
      };
      /* ES module loading failures produce rejected promises, not synchronous errors.
         Without this handler, the loading screen stays visible forever with no error shown. */
      window.addEventListener('unhandledrejection',function(e){
        var msg=e.reason&&e.reason.message?e.reason.message:String(e.reason||'Module loading failed');
        window.__guildLoadErrors.push({msg:msg,err:e.reason});
        __guildShowLoadError(msg);
      });
    </script>
    <!-- INLINE STALE-BUILD DETECTION (Layer 0 — runs BEFORE any module script)
         window.__HTML_BUILD_TIME__ is injected by Vite's versionJsonPlugin at build time.
         In production: compares the build time baked into this HTML with the latest
         version.json on the server. If they differ, this HTML is stale (served from
         browser HTTP cache or old SW), and the JS chunks it references likely don't exist.
         Auto-clears caches and reloads BEFORE the module script even tries to load.
         In development: __HTML_BUILD_TIME__ is undefined, so this is a no-op.

         Also pre-fetches version.json and stores the promise on window.__versionCheck
         so main.tsx can reuse it instead of making a second fetch. -->
    <script>
      (function(){
        if(!window.__HTML_BUILD_TIME__)return; /* dev mode — skip */
        var base=document.querySelector('base[href]');
        base=base?base.getAttribute('href'):'/';
        /* Start fetch immediately — module script can reuse this promise */
        window.__versionCheck=fetch(base+'version.json?_='+Date.now(),{cache:'no-store'})
          .then(function(r){return r.ok?r.json():null})
          .catch(function(){return null}); /* offline — proceed */
        window.__versionCheck.then(function(data){
          if(!data||!data.buildTime)return;
          if(data.buildTime===window.__HTML_BUILD_TIME__)return; /* HTML is fresh */
          /* HTML is stale — JS chunks probably have wrong hashes.
             Clear everything and reload BEFORE module script tries to load. */
          console.warn('[Guild Life] Stale HTML detected (inline check). Build:',
            window.__HTML_BUILD_TIME__,'Server:',data.buildTime);
          /* Check reload loop prevention — max 2 reloads per 60s */
          try{
            var raw=sessionStorage.getItem('guild-stale-reload');
            if(raw){
              var rd=JSON.parse(raw);
              if(Date.now()-rd.ts<60000&&rd.count>=2){
                console.warn('[Guild Life] Reload limit reached — showing manual button instead');
                return;
              }
              if(Date.now()-rd.ts>=60000) raw=null;
            }
            var reloadData=raw?JSON.parse(raw):{ts:Date.now(),count:0};
            if(!reloadData.ts)reloadData.ts=Date.now();
            reloadData.count++;
            sessionStorage.setItem('guild-stale-reload',JSON.stringify(reloadData));
          }catch(e){}
          /* Properly await cache cleanup before reloading */
          Promise.resolve()
            .then(function(){
              var promises=[];
              if(navigator.serviceWorker){
                promises.push(
                  navigator.serviceWorker.getRegistrations().then(function(regs){
                    return Promise.all(regs.map(function(r){return r.unregister()}));
                  })
                );
              }
              if(window.caches){
                promises.push(
                  caches.keys().then(function(keys){
                    return Promise.all(keys.map(function(k){return caches.delete(k)}));
                  })
                );
              }
              return Promise.all(promises);
            })
            .catch(function(){})
            .then(function(){
              /* Wait for cleanup to propagate */
              setTimeout(function(){location.reload()},500);
            });
        });
      })();
    </script>
    <script type="module" src="/src/main.tsx"></script>
    <!-- Fallback: polling loop checks every 3s if React has mounted.
         If loading-screen is still visible after 5s, shows "Clear Cache & Reload" button.
         The button unregisters SWs, clears all caches, waits 300ms, then reloads. -->
    <script>
      (function(){
        var shown=false;
        function guildFallbackCheck(){
          var root=document.getElementById('root');
          var ls=root&&root.querySelector('#loading-screen');
          if(!ls){shown=true;return;} /* React mounted — stop checking */
          if(shown)return; /* Already showed button */
          shown=true;
          var p=document.createElement('p');
          p.className='fallback-btn';
          p.style.cssText='margin-top:1.5rem;font-family:serif;';
          p.innerHTML='<button onclick="(function(){if(navigator.serviceWorker){navigator.serviceWorker.getRegistrations().then(function(r){r.forEach(function(s){s.unregister()})});}if(window.caches){caches.keys().then(function(n){n.forEach(function(k){caches.delete(k)})});}setTimeout(function(){location.reload()},300);})()" style="padding:.75rem 2rem;font-size:1rem;font-family:serif;background:linear-gradient(135deg,hsl(45,85%,55%),hsl(35,70%,40%));color:#1f170a;border:none;border-radius:.25rem;cursor:pointer;font-weight:bold;">Clear Cache &amp; Reload</button>';
          ls.appendChild(p);
        }
        /* Poll every 3s starting at 5s. The inline version check and main.tsx
           pre-mount check need time to complete before we show the fallback button. */
        var t=setInterval(function(){
          var root=document.getElementById('root');
          var ls=root&&root.querySelector('#loading-screen');
          if(!ls){clearInterval(t);return;} /* React mounted */
          guildFallbackCheck();
        },3000);
        setTimeout(guildFallbackCheck,5000);
      })();
    </script>
  </body>
</html>
