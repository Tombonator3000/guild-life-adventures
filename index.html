<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <!-- Prevent browser HTTP caching of this HTML page.
         GitHub Pages sets Cache-Control: max-age=600 (10 min). During that window,
         a stale cached HTML file may reference old JS chunk hashes that no longer exist
         on the server, causing "Loading the realm..." to hang forever.
         These meta tags tell the browser to always revalidate this page. -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <!-- Favicon and apple-touch-icon paths are relative so they work on both
         root-hosted (Lovable) and subpath-hosted (GitHub Pages) deployments.
         Previously these used absolute "/" paths which 404'd on GitHub Pages. -->
    <link rel="icon" type="image/png" href="favicon.png">
    <title>Guild Life</title>
    <meta name="description" content="A fantasy life simulation game inspired by Jones in the Fast Lane">
    <meta name="author" content="Guild Life Adventures" />

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#2e1f0f" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Guild Life" />
    <link rel="apple-touch-icon" href="apple-touch-icon.png" />

    <!-- Google Fonts - loaded as <link> instead of CSS @import to avoid render-blocking -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet" />

    <!-- Open Graph -->


    <meta property="og:type" content="website" />

    <meta name="twitter:card" content="summary_large_image" />
    
  
  
  
  <meta property="og:title" content="Guild Life">
  <meta name="twitter:title" content="Guild Life">
  <meta property="og:description" content="A fantasy life simulation game inspired by Jones in the Fast Lane">
  <meta name="twitter:description" content="A fantasy life simulation game inspired by Jones in the Fast Lane">
  <meta property="og:image" content="https://storage.googleapis.com/gpt-engineer-file-uploads/attachments/og-images/3c0a908b-5a62-431a-a708-020b4d0fa1ab?Expires=1771244125&amp;GoogleAccessId=go-api-on-aws%40gpt-engineer-390607.iam.gserviceaccount.com&amp;Signature=wR%2BZ4DTsgG9wr3TPvYhrgNa30rotLNwaBlRwUNFjew4Lv5ycErcHa8JphLrqYKM5RPCt%2FaVMVrpTEIc46341%2B4F6bWsff8X5fSu5ZIPX4Z%2FhBjTxFJKQqcxyjgM97baz7WzH%2F3cUCFU9pEpFkZsiE7prnl%2FgaQXPFGTultcX%2BFXtGW4RPZY6xDbu%2BKeKBv4yhomH8RMBhKxa7Nm9y3AD45JW6%2BMCHRCW4LJQfl0WzS1Tn50ENlog6jf79sKCT5GwzGZX0dnuYY0XR95HpGyXugo%2FipcVDh%2FBzcvf%2BHpBvegdtP7ki6DJYMGucNXN9ecuGArQ5x47m8pbZZqLr39cbw%3D%3D">
  <meta name="twitter:image" content="https://storage.googleapis.com/gpt-engineer-file-uploads/attachments/og-images/3c0a908b-5a62-431a-a708-020b4d0fa1ab?Expires=1771244125&amp;GoogleAccessId=go-api-on-aws%40gpt-engineer-390607.iam.gserviceaccount.com&amp;Signature=wR%2BZ4DTsgG9wr3TPvYhrgNa30rotLNwaBlRwUNFjew4Lv5ycErcHa8JphLrqYKM5RPCt%2FaVMVrpTEIc46341%2B4F6bWsff8X5fSu5ZIPX4Z%2FhBjTxFJKQqcxyjgM97baz7WzH%2F3cUCFU9pEpFkZsiE7prnl%2FgaQXPFGTultcX%2BFXtGW4RPZY6xDbu%2BKeKBv4yhomH8RMBhKxa7Nm9y3AD45JW6%2BMCHRCW4LJQfl0WzS1Tn50ENlog6jf79sKCT5GwzGZX0dnuYY0XR95HpGyXugo%2FipcVDh%2FBzcvf%2BHpBvegdtP7ki6DJYMGucNXN9ecuGArQ5x47m8pbZZqLr39cbw%3D%3D">
</head>

  <body>
    <div id="root">
      <!-- Loading screen — visible until React mounts and replaces this content -->
      <div id="loading-screen" style="min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#1f170a;color:#e8dcc8;font-family:serif;text-align:center;padding:2rem;">
        <h1 style="font-size:2rem;margin-bottom:1rem;color:#d4a537;">Guild Life Adventures</h1>
        <p id="loading-status" style="font-size:1rem;opacity:0.7;">Loading the realm...</p>
        <noscript><p style="margin-top:1rem;color:#c44;">JavaScript is required to play this game.</p></noscript>
      </div>
    </div>
    <!-- Catch JS errors that occur before React mounts (module load failures, etc.) -->
    <script>
      window.__guildLoadErrors=[];
      /* Loading state flags — used by fallback script to decide when to show
         the "Clear Cache & Reload" button. Without these, the fallback shows
         too early (before the module has time to load), causing users to click
         it and enter a reload loop. */
      window.__guildAppLoading=false;  /* true once loadApp() injects module */
      window.__guildAppFailed=false;   /* true if module fails to load */
      window.__guildReactMounted=false; /* true once React renders */
      /* Update the loading status text so users see progress, not a frozen screen */
      function __guildSetStatus(msg){
        var el=document.getElementById('loading-status');
        if(el)el.textContent=msg;
      }
      function __guildShowLoadError(msg){
        window.__guildAppFailed=true;
        setTimeout(function(){
          var ls=document.getElementById('loading-screen');
          if(!ls)return;
          if(ls.querySelector('.error-info'))return;
          var d=document.createElement('div');
          d.className='error-info';
          d.style.cssText='margin-top:1rem;';
          d.innerHTML='<p style="color:#c44;font-size:0.95rem;">Failed to load the realm</p>'
            +'<p style="font-size:0.8rem;opacity:0.7;max-width:500px;word-break:break-word;">'+msg+'</p>'
            +'<button onclick="try{var u=new URL(location.href);u.searchParams.set(\'_gv\',Date.now());location.replace(u.toString())}catch(e){location.reload()}" style="margin-top:1rem;padding:.5rem 1.5rem;background:#d4a537;color:#1f170a;border:none;border-radius:4px;cursor:pointer;font-size:1rem;">Reload</button>';
          ls.appendChild(d);
        },2000);
      }
      window.onerror=function(msg,src,line,col,err){
        window.__guildLoadErrors.push({msg:msg,src:src,err:err});
        __guildShowLoadError(msg);
      };
      /* ES module loading failures produce rejected promises, not synchronous errors.
         Without this handler, the loading screen stays visible forever with no error shown. */
      window.addEventListener('unhandledrejection',function(e){
        var msg=e.reason&&e.reason.message?e.reason.message:String(e.reason||'Module loading failed');
        window.__guildLoadErrors.push({msg:msg,err:e.reason});
        __guildShowLoadError(msg);
      });
    </script>
    <!-- DEFERRED MODULE LOADING + STALE-BUILD DETECTION (Layer 0)
         In production, deferModulePlugin removes the <script type="module"> tag and
         stores its URL in window.__ENTRY__. This script loads it dynamically AFTER
         confirming the HTML is fresh via version.json.

         KEY FIX (2026-02-16): Replaced complex hot-swap/retry logic with simple
         auto-reload approach. Previous versions tried to hot-swap stale entry URLs
         in-page, but this failed when GitHub Pages CDN cached version.json too
         (Fastly doesn't honor client-side Cache-Control headers). Now we just
         reload the page with ?_gv=timestamp which creates a CDN cache miss,
         getting fresh HTML from origin. Combined with selfDestroying SW in
         vite.config.ts, this eliminates both CDN stale cache and SW interference.

         In development, window.__HTML_BUILD_TIME__ is undefined and window.__ENTRY__
         doesn't exist, so the module script tag below loads normally. -->
    <script>
      (function(){
        var RELOAD_KEY='guild-reload-count';
        var RELOAD_WINDOW=120000; /* 2 min */
        var MAX_RELOADS=3;

        function getReloadCount(){
          try{
            var d=JSON.parse(sessionStorage.getItem(RELOAD_KEY)||'null');
            if(!d||Date.now()-d.ts>RELOAD_WINDOW)return 0;
            return d.count||0;
          }catch(e){return 0;}
        }
        /* Auto-reload with CDN cache-busting URL.
           ?_gv=timestamp changes the full page URL → CDN cache miss → fresh HTML from origin.
           Uses sessionStorage counter to prevent infinite reload loops (max 3 in 2 min). */
        function autoReload(reason){
          if(getReloadCount()>=MAX_RELOADS){
            console.warn('[Guild Life] Reload limit reached — showing manual recovery');
            window.__guildAppFailed=true;
            __guildShowLoadError('New version deploying. Please wait a minute and refresh, or clear your browser cache.');
            return;
          }
          console.log('[Guild Life] Auto-reloading:',reason);
          __guildSetStatus('Updating — reloading...');
          try{
            var d=JSON.parse(sessionStorage.getItem(RELOAD_KEY)||'null');
            if(!d||Date.now()-d.ts>RELOAD_WINDOW)d={ts:Date.now(),count:0};
            d.count++;
            sessionStorage.setItem(RELOAD_KEY,JSON.stringify(d));
          }catch(e){}
          try{
            var u=new URL(location.href);
            u.searchParams.set('_gv',String(Date.now()));
            location.replace(u.toString());
          }catch(e){location.reload();}
        }

        /* Unregister legacy SWs. Users with old SWs from pre-fix deployments
           need cleanup. The selfDestroying SW handles future cleanup, but this
           covers the transition for existing users. */
        function cleanupSWs(){
          try{
            if(!navigator.serviceWorker)return Promise.resolve();
            return navigator.serviceWorker.getRegistrations().then(function(regs){
              return Promise.all(regs.map(function(r){return r.unregister();}));
            }).catch(function(){});
          }catch(e){return Promise.resolve();}
        }

        function loadApp(){
          if(document.querySelector('script[data-entry]'))return;
          var src=window.__ENTRY__;
          if(!src)return; /* dev mode */
          window.__guildAppLoading=true;
          __guildSetStatus('Loading game modules...');
          console.log('[Guild Life] Loading entry module:',src);
          /* Re-add modulepreload hints */
          (window.__PRELOADS__||[]).forEach(function(href){
            var l=document.createElement('link');
            l.rel='modulepreload';l.crossOrigin='';l.href=href;
            document.head.appendChild(l);
          });
          var s=document.createElement('script');
          s.type='module';s.crossOrigin='';s.src=src;
          s.setAttribute('data-entry','1');
          /* Entry module 404 (stale chunks deleted) → auto-reload to get fresh HTML */
          s.onerror=function(){
            console.error('[Guild Life] Entry module 404:',src);
            autoReload('entry module 404');
          };
          document.body.appendChild(s);
          /* Clean up ?_gv from URL bar */
          if(location.search.indexOf('_gv=')!==-1){
            try{
              var url=new URL(location.href);
              url.searchParams.delete('_gv');
              history.replaceState(null,'',url.toString());
            }catch(e){}
          }
        }

        if(!window.__HTML_BUILD_TIME__){return;} /* dev mode */

        var base=window.__HTML_BASE__||'/';
        __guildSetStatus('Checking for updates...');
        window.__guildVersionCheckStarted=true;

        /* Step 1: Clean up legacy SWs (max 2s) */
        var swDone=cleanupSWs();
        var swTimeout=new Promise(function(r){setTimeout(r,2000);});
        Promise.race([swDone,swTimeout]).then(function(){
          /* Step 2: Fetch version.json with cache bypass */
          return fetch(base+'version.json?_='+Date.now(),{
            cache:'no-store',
            headers:{'Cache-Control':'no-cache','Pragma':'no-cache'}
          }).then(function(r){return r.ok?r.json():null;})
            .catch(function(){return null;});
        }).then(function(data){
          if(document.querySelector('script[data-entry]'))return;
          if(data&&data.buildTime&&data.buildTime!==window.__HTML_BUILD_TIME__){
            /* Stale HTML detected — version.json is fresh.
               Auto-reload to get fresh HTML with correct entry URL. */
            console.warn('[Guild Life] Stale HTML detected. HTML:',
              window.__HTML_BUILD_TIME__,'Server:',data.buildTime);
            autoReload('stale HTML detected');
            return;
          }
          /* Build times match (both fresh, or both stale from CDN) or
             version.json unavailable. Load the app — if entry 404s,
             onerror will trigger auto-reload to get fresh HTML. */
          if(data&&data.buildTime){
            console.log('[Guild Life] Build times match — loading app');
          }else{
            console.log('[Guild Life] version.json unavailable — loading app');
          }
          loadApp();
        }).catch(function(){
          console.error('[Guild Life] Version check failed — loading app');
          loadApp();
        });

        /* Pipeline timeout: if version check hangs >8s, load anyway */
        setTimeout(function(){
          if(!document.querySelector('script[data-entry]')){
            console.log('[Guild Life] Pipeline timed out — loading app');
            loadApp();
          }
        },8000);
      })();
    </script>
    <!-- Dev mode entry point — in production, deferModulePlugin removes the
         built version and stores it in window.__ENTRY__ for deferred loading -->
    <script type="module" src="/src/main.tsx"></script>
    <!-- Fallback: Shows "Clear Cache & Reload" button when loading genuinely fails.
         Auto-reload in Layer 0 handles most cases. This is the manual escape hatch
         for edge cases where auto-reload reaches its limit or React fails to mount. -->
    <script>
      (function(){
        var shown=false;
        var startTime=Date.now();
        var RELOAD_KEY='guild-reload-count';
        var TIMEOUT=12000; /* 12s — auto-reload handles fast recovery, this is the safety net */

        function shouldShowButton(){
          if(window.__guildReactMounted)return false;
          if(window.__guildAppFailed)return true;
          var elapsed=Date.now()-startTime;
          if(window.__guildAppLoading&&elapsed<TIMEOUT)return false;
          if(window.__guildVersionCheckStarted&&!window.__guildAppLoading&&elapsed<TIMEOUT)return false;
          return elapsed>=TIMEOUT;
        }

        function manualReload(btn){
          if(btn){btn.textContent='Reloading...';btn.disabled=true;}
          /* Check reload loop */
          var count=0;
          try{
            var d=JSON.parse(sessionStorage.getItem(RELOAD_KEY)||'null');
            if(d&&Date.now()-d.ts<120000)count=d.count||0;
          }catch(e){}
          if(count>=3){
            var ls=document.getElementById('loading-screen');
            if(ls&&!ls.querySelector('.loop-info')){
              var div=document.createElement('div');
              div.className='loop-info';
              div.style.cssText='margin-top:1rem;max-width:400px;';
              div.innerHTML='<p style="color:#d4a537;font-size:0.95rem;margin-bottom:0.5rem;">Multiple reloads detected</p>'
                +'<p style="font-size:0.8rem;opacity:0.8;">A new version may still be deploying. Try:</p>'
                +'<ol style="font-size:0.8rem;opacity:0.8;text-align:left;margin:0.5rem 0;">'
                +'<li>Wait 1-2 minutes, then refresh</li>'
                +'<li>Open a new tab and navigate to the game URL</li>'
                +'<li>Clear your browser cache (Ctrl+Shift+Del)</li>'
                +'</ol>'
                +'<button onclick="try{sessionStorage.removeItem(\'guild-reload-count\');localStorage.clear()}catch(e){}try{var u=new URL(location.href);u.searchParams.set(\'_gv\',Date.now());location.replace(u.toString())}catch(e){location.reload()}" '
                +'style="margin-top:0.5rem;padding:.5rem 1.5rem;background:#c44;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:0.9rem;">Hard Reset (clears all game data)</button>';
              ls.appendChild(div);
            }
            return;
          }
          /* Bump counter and reload with cache-buster */
          try{
            var dd=JSON.parse(sessionStorage.getItem(RELOAD_KEY)||'null');
            if(!dd||Date.now()-dd.ts>120000)dd={ts:Date.now(),count:0};
            dd.count++;
            sessionStorage.setItem(RELOAD_KEY,JSON.stringify(dd));
          }catch(e){}
          try{var u=new URL(location.href);u.searchParams.set('_gv',Date.now());location.replace(u.toString());}
          catch(e){location.reload();}
        }

        var t=setInterval(function(){
          var root=document.getElementById('root');
          var ls=root&&root.querySelector('#loading-screen');
          if(!ls){clearInterval(t);return;}
          if(shown||!shouldShowButton())return;
          shown=true;
          var p=document.createElement('p');
          p.className='fallback-btn';
          p.style.cssText='margin-top:1.5rem;font-family:serif;';
          var btn=document.createElement('button');
          btn.textContent='Clear Cache & Reload';
          btn.style.cssText='padding:.75rem 2rem;font-size:1rem;font-family:serif;background:linear-gradient(135deg,hsl(45,85%,55%),hsl(35,70%,40%));color:#1f170a;border:none;border-radius:.25rem;cursor:pointer;font-weight:bold;';
          btn.onclick=function(){manualReload(btn);};
          p.appendChild(btn);
          ls.appendChild(p);
        },2000);
      })();
    </script>
  </body>
</html>
