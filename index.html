<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <!-- Prevent browser HTTP caching of this HTML page.
         GitHub Pages sets Cache-Control: max-age=600 (10 min). During that window,
         a stale cached HTML file may reference old JS chunk hashes that no longer exist
         on the server, causing "Loading the realm..." to hang forever.
         These meta tags tell the browser to always revalidate this page. -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <link rel="icon" type="image/png" href="/favicon.png" />
    <title>Guild Life</title>
    <meta name="description" content="A fantasy life simulation game inspired by Jones in the Fast Lane">
    <meta name="author" content="Guild Life Adventures" />

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#2e1f0f" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Guild Life" />
    <link rel="apple-touch-icon" href="apple-touch-icon.png" />

    <!-- Google Fonts - loaded as <link> instead of CSS @import to avoid render-blocking -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet" />

    <!-- Open Graph -->


    <meta property="og:type" content="website" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta property="og:title" content="Guild Life">
  <meta name="twitter:title" content="Guild Life">
  <meta property="og:description" content="A fantasy life simulation game inspired by Jones in the Fast Lane">
  <meta name="twitter:description" content="A fantasy life simulation game inspired by Jones in the Fast Lane">
</head>

  <body>
    <div id="root">
      <!-- Loading screen — visible until React mounts and replaces this content -->
      <div id="loading-screen" style="min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#1f170a;color:#e8dcc8;font-family:serif;text-align:center;padding:2rem;">
        <h1 style="font-size:2rem;margin-bottom:1rem;color:#d4a537;">Guild Life Adventures</h1>
        <p style="font-size:1rem;opacity:0.7;">Loading the realm...</p>
        <noscript><p style="margin-top:1rem;color:#c44;">JavaScript is required to play this game.</p></noscript>
      </div>
    </div>
    <!-- Catch JS errors that occur before React mounts (module load failures, etc.) -->
    <script>
      window.__guildLoadErrors=[];
      function __guildShowLoadError(msg){
        setTimeout(function(){
          var ls=document.getElementById('loading-screen');
          if(!ls)return;
          if(ls.querySelector('.error-info'))return;
          var d=document.createElement('div');
          d.className='error-info';
          d.style.cssText='margin-top:1rem;';
          d.innerHTML='<p style="color:#c44;font-size:0.95rem;">Failed to load the realm</p>'
            +'<p style="font-size:0.8rem;opacity:0.7;max-width:500px;word-break:break-word;">'+msg+'</p>'
            +'<button onclick="try{var u=new URL(location.href);u.searchParams.set(\'_gv\',Date.now());location.replace(u.toString())}catch(e){location.reload()}" style="margin-top:1rem;padding:.5rem 1.5rem;background:#d4a537;color:#1f170a;border:none;border-radius:4px;cursor:pointer;font-size:1rem;">Reload</button>';
          ls.appendChild(d);
        },3000);
      }
      window.onerror=function(msg,src,line,col,err){
        window.__guildLoadErrors.push({msg:msg,src:src,err:err});
        __guildShowLoadError(msg);
      };
      /* ES module loading failures produce rejected promises, not synchronous errors.
         Without this handler, the loading screen stays visible forever with no error shown. */
      window.addEventListener('unhandledrejection',function(e){
        var msg=e.reason&&e.reason.message?e.reason.message:String(e.reason||'Module loading failed');
        window.__guildLoadErrors.push({msg:msg,err:e.reason});
        __guildShowLoadError(msg);
      });
    </script>
    <!-- DEFERRED MODULE LOADING + STALE-BUILD DETECTION (Layer 0)
         In production, deferModulePlugin removes the <script type="module"> tag and
         stores its URL in window.__ENTRY__. This script loads it dynamically AFTER
         confirming the HTML is fresh via version.json. This eliminates the race
         condition where stale HTML starts loading non-existent JS chunks in parallel
         with the version check.

         KEY FIX (2026-02-15): When stale HTML is detected, instead of reloading
         (which may serve the SAME stale HTML from CDN cache), we hot-swap the
         entry module URL from version.json and load the fresh module directly.
         version.json is always fresh (fetched with cache:'no-store' + unique URL).

         In development, window.__HTML_BUILD_TIME__ is undefined and window.__ENTRY__
         doesn't exist, so the module script tag below loads normally. -->
    <script>
      (function(){
        /* ===== loadApp: dynamically inject the entry module ===== */
        function loadApp(){
          if(document.querySelector('script[data-entry]'))return; /* already loading */
          var src=window.__ENTRY__;
          if(!src)return; /* dev mode — module script is in the HTML */
          /* Re-add modulepreload hints for performance */
          (window.__PRELOADS__||[]).forEach(function(href){
            var l=document.createElement('link');
            l.rel='modulepreload';l.crossOrigin='';l.href=href;
            document.head.appendChild(l);
          });
          /* Inject the entry module */
          var s=document.createElement('script');
          s.type='module';s.crossOrigin='';s.src=src;
          s.setAttribute('data-entry','1');
          /* Handle module load failures (404 for old chunks, network errors).
             <script type="module"> errors don't trigger window.onerror or
             unhandledrejection — they silently fail, leaving the loading
             screen visible forever. This onerror catches those cases. */
          s.onerror=function(){
            console.error('[Guild Life] Entry module failed to load:',src);
            __guildShowLoadError('Module failed to load: '+src.split('/').pop());
          };
          document.body.appendChild(s);
          /* Clean up cache-buster from URL (added by stale-build reload) */
          if(location.search.indexOf('_gv=')!==-1){
            try{
              var url=new URL(location.href);
              url.searchParams.delete('_gv');
              history.replaceState(null,'',url.toString());
            }catch(e){}
          }
        }

        /* ===== swapCss: replace stale CSS links with fresh ones ===== */
        function swapCss(freshCssUrls){
          if(!freshCssUrls||!freshCssUrls.length)return;
          /* Remove stale CSS links (Vite-generated ones in /assets/) */
          var staleLinks=document.querySelectorAll('link[rel="stylesheet"][href*="/assets/"]');
          for(var i=0;i<staleLinks.length;i++){staleLinks[i].remove();}
          /* Add fresh CSS links */
          for(var j=0;j<freshCssUrls.length;j++){
            var link=document.createElement('link');
            link.rel='stylesheet';link.crossOrigin='';link.href=freshCssUrls[j];
            document.head.appendChild(link);
          }
        }

        if(!window.__HTML_BUILD_TIME__){
          /* Dev mode — no version check, module loads from HTML script tag */
          return;
        }

        var base=window.__HTML_BASE__||'/';

        /* Fetch version.json — reused by main.tsx via window.__versionCheck */
        window.__versionCheck=fetch(base+'version.json?_='+Date.now(),{cache:'no-store'})
          .then(function(r){return r.ok?r.json():null})
          .catch(function(){return null});

        window.__versionCheck.then(function(data){
          if(!data||!data.buildTime){
            /* Can't determine version — load the app anyway */
            loadApp();
            return;
          }
          if(data.buildTime===window.__HTML_BUILD_TIME__){
            /* HTML is fresh — safe to load */
            loadApp();
            return;
          }

          /* ===== STALE BUILD DETECTED ===== */
          console.warn('[Guild Life] Stale HTML detected. HTML:',
            window.__HTML_BUILD_TIME__,'Server:',data.buildTime);

          /* ===== HOT-SWAP FIX: Load fresh module directly from version.json =====
             Previous approach: reload with ?_gv=<timestamp> to force fresh HTML.
             Problem: GitHub Pages CDN may still serve cached HTML within max-age=600
             window, causing a reload loop that ends with loading stale chunks (404).

             New approach: version.json contains the fresh entry module URL and CSS URLs.
             Since version.json is fetched with cache:'no-store' + unique query param,
             it's ALWAYS fresh. We hot-swap to the fresh module without reloading.
             This works even when the HTML itself is stale/cached. */
          if(data.entry){
            console.log('[Guild Life] Hot-swapping to fresh entry:',data.entry);
            /* Replace stale CSS with fresh CSS from version.json */
            swapCss(data.css);
            /* Load the fresh entry module instead of the stale one from HTML */
            window.__ENTRY__=data.entry;
            loadApp();
            return;
          }

          /* Fallback for older deploys without entry in version.json:
             clear caches and reload with cache-busting URL */
          console.warn('[Guild Life] version.json missing entry URL — falling back to reload');

          /* Clear SW caches, then reload */
          Promise.resolve()
            .then(function(){
              var promises=[];
              if(navigator.serviceWorker){
                promises.push(
                  navigator.serviceWorker.getRegistrations().then(function(regs){
                    return Promise.all(regs.map(function(r){return r.unregister()}));
                  })
                );
              }
              if(window.caches){
                promises.push(
                  caches.keys().then(function(keys){
                    return Promise.all(keys.map(function(k){return caches.delete(k)}));
                  })
                );
              }
              return Promise.all(promises);
            })
            .catch(function(){})
            .then(function(){
              setTimeout(function(){
                try{
                  var url=new URL(location.href);
                  url.searchParams.set('_gv',String(Date.now()));
                  location.replace(url.toString());
                }catch(e){location.reload();}
              },500);
            });
        });

        /* Timeout: if version check takes >8s, load anyway (slow/offline). */
        setTimeout(function(){
          if(!document.querySelector('script[data-entry]')){
            console.log('[Guild Life] Version check timed out — loading app');
            loadApp();
          }
        },8000);
      })();
    </script>
    <!-- Dev mode entry point — in production, deferModulePlugin removes the
         built version and stores it in window.__ENTRY__ for deferred loading -->
    <script type="module" src="/src/main.tsx"></script>
    <!-- Fallback: polling loop checks every 3s if React has mounted.
         If loading-screen is still visible after 5s, shows "Clear Cache & Reload" button.
         Button clears SW caches and reloads with cache-busting URL param. -->
    <script>
      (function(){
        var shown=false;
        function cacheReload(){
          if(navigator.serviceWorker){navigator.serviceWorker.getRegistrations().then(function(r){r.forEach(function(s){s.unregister()})});}
          if(window.caches){caches.keys().then(function(n){n.forEach(function(k){caches.delete(k)})});}
          setTimeout(function(){
            try{var u=new URL(location.href);u.searchParams.set('_gv',Date.now());location.replace(u.toString());}
            catch(e){location.reload();}
          },300);
        }
        function guildFallbackCheck(){
          var root=document.getElementById('root');
          var ls=root&&root.querySelector('#loading-screen');
          if(!ls){shown=true;return;}
          if(shown)return;
          shown=true;
          var p=document.createElement('p');
          p.className='fallback-btn';
          p.style.cssText='margin-top:1.5rem;font-family:serif;';
          var btn=document.createElement('button');
          btn.textContent='Clear Cache & Reload';
          btn.style.cssText='padding:.75rem 2rem;font-size:1rem;font-family:serif;background:linear-gradient(135deg,hsl(45,85%,55%),hsl(35,70%,40%));color:#1f170a;border:none;border-radius:.25rem;cursor:pointer;font-weight:bold;';
          btn.onclick=cacheReload;
          p.appendChild(btn);
          ls.appendChild(p);
        }
        var t=setInterval(function(){
          var root=document.getElementById('root');
          var ls=root&&root.querySelector('#loading-screen');
          if(!ls){clearInterval(t);return;}
          guildFallbackCheck();
        },3000);
        setTimeout(guildFallbackCheck,5000);
      })();
    </script>
  </body>
</html>
